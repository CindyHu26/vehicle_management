<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公務車管理系統</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">

    <style>
        .ts-control, .ts-wrapper.single .ts-control { cursor: text; }
        .ts-control input {
        width: auto !important;
        min-width: 6ch;
        opacity: 1 !important;
        pointer-events: auto !important;
        }
        .ts-dropdown .ts-dropdown-input { width: 100%; padding: 0.5rem 0.75rem; }
        .ts-dropdown .ts-dropdown-input input {
        width: 100% !important;
        border: 1px solid #d1d5db;
        padding: 0.5rem 0.75rem; border-radius: 0.375rem;
        }
        /* 防止其他樣式誤傷 */
        .ts-wrapper, .ts-control, .ts-control input, .ts-dropdown .ts-dropdown-input input {
        pointer-events: auto !important;
        }
    </style>
    </head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-800">公務車管理系統</h1>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 flex space-x-6">
        
        <nav class="w-1/4">
            <div class="bg-white shadow-md rounded-lg p-4">
                <h2 class="text-lg font-semibold mb-4">選單</h2>
                <ul class="space-y-2">
                    <li>
                        <a href="#" 
                           class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600 font-bold"
                           hx-get="/dashboard" hx-target="#main-content"
                           hx-swap="innerHTML"
                           hx-trigger="load, click" > 儀表板
                        </a>
                    </li>

                    <li>
                        <a href="#" 
                           class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                           hx-get="/vehicle-management" hx-target="#main-content"
                           hx-swap="innerHTML"
                           
                           hx-trigger="load, click" >
                          車輛管理
                        </a>
                    </li>
                    <li>
                        <a href="#" 
                           class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                           hx-get="/employee-management" hx-target="#main-content"
                           hx-swap="innerHTML"
                           >
                          員工管理
                        </a>
                    </li>
                    <li>
                        <a href="#" 
                        class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                        hx-get="/maintenance-management"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        >
                        保養管理 (全)
                        </a>
                    </li>
                    <li>
                        <a href="#" 
                        class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                        hx-get="/inspection-management"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        >
                        檢驗管理 (全)
                        </a>
                    </li>
                    <li>
                        <a href="#" 
                        class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                        hx-get="/fee-management"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        >
                        費用管理 (全)
                        </a>
                    </li>  
                    <li>
                        <a href="#" 
                        class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                        hx-get="/parking-management"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        >
                        停車場管理
                        </a>
                    </li>   
                    <li>
                        <a href="#" 
                        class="block px-4 py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-600"
                        hx-get="/import-export-management"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        >
                        資料匯入/匯出
                        </a>
                    </li>              
                    </ul>
            </div>
        </nav>

        <main class="w-3/4">
            <div id="main-content">
                <p>正在載入...</p>
            </div>
        </main>
    
    </div> 
    
    <div id="modal-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <script>
    function initializeTomSelect(el) {
        if (!el || !el.classList.contains('searchable-select') || el.dataset.tsInitialized) return;
        el.dataset.tsInitialized = '1';

        const ts = new TomSelect(el, {
        create: false,
        sortField: { field: "text", direction: "asc" },
        plugins: ['dropdown_input'],
        openOnFocus: true,
        closeAfterSelect: true,   // 建議先別關，方便連續輸入
        debounce: 100,
        score(search) {
            return function(item) {
            const t = (item.text || '').toLowerCase();
            const q = (search || '').toLowerCase();
            if (!q) return 1;
            return t.indexOf(q) > -1 ? 1 : 0;
            };
        },
        onInitialize() {
            const bindIme = (inputEl) => {
            if (!inputEl || inputEl.__imeBound) return;
            inputEl.__imeBound = true;
            let composing = false;
            inputEl.addEventListener('compositionstart', () => { composing = true; });
            inputEl.addEventListener('compositionend',   () => {
                composing = false;
                this.onSearchChange(inputEl.value);
            });
            inputEl.addEventListener('keyup', (e) => {
                if (composing) e.stopPropagation();
            }, true);
            };

            // 1) 控制列 input（永遠存在）
            bindIme(this.control_input);

            // 2) 下拉面板的輸入框（展開時才生成）
            const hookDropdownInput = () => {
            const di = this.dropdown && this.dropdown.querySelector('.ts-dropdown-input input');
            bindIme(di);
            };
            hookDropdownInput();
            this.on('dropdown_open', hookDropdownInput);
        }
        });
    }

    // ✅ 內容已插入 DOM 後再初始化
    document.body.addEventListener('htmx:afterSwap', function (event) {
        const root = event.detail.target || event.target;
        if (!root) return;

        if (root.classList && root.classList.contains('searchable-select')) {
        initializeTomSelect(root);
        }
        root.querySelectorAll && root.querySelectorAll('.searchable-select').forEach(initializeTomSelect);
    });

    // 首頁既有（非 HTMX 載入）的也掃一次
    document.querySelectorAll('.searchable-select').forEach(initializeTomSelect);
    </script>
    
    <!-- 顯示 Toast 的容器 -->
    <div id="toast-root" class="fixed top-4 right-4 z-[1000] space-y-2"></div>
    <script>
    /**
     * 負責在畫面上顯示一個 Toast 提示
     */
    function showToast(msg, level='success', timeout=2200){
        const root = document.getElementById('toast-root'); if(!root) return;
        const el = document.createElement('div');
        const map = {success:'bg-green-600', info:'bg-blue-600', warning:'bg-yellow-600', danger:'bg-red-600'};
        el.className = (map[level]||map.success) + ' text-white px-4 py-2 rounded-lg shadow-lg';
        el.textContent = msg || '完成';
        root.appendChild(el);
        setTimeout(()=>el.remove(), timeout);
    }

    /**
     * (!!!) 關鍵的監聽器 (!!!)
     * 監聽從伺服器 (HX-Trigger) 發來的 "showToast" 事件
     */
    document.body.addEventListener('showToast', (e)=>{
        const detail = e.detail || {};
        
        // 1. 顯示 Toast 訊息
        showToast(detail.message, detail.level);
        
        // 2. 檢查伺服器是否要求「關閉彈窗」
        if (detail.closeModal === true) {
            // 找到所有開啟的 modal (用 .fixed) 並移除
            document.querySelectorAll('.fixed.inset-0').forEach(n => n.remove());
        }
        
        // (!!!) 移除 htmx.trigger(...) 那一行 (!!!)
        // 刷新工作完全交給 HX-Trigger 的其他 key (例如 "refreshParkingSpotsList": true)
    });
    </script>

</body>
</html>