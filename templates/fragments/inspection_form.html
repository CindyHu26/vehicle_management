<div 
  class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50"
  hx-on:click="if (event.target === this) this.remove()"
>
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">

    <h2 class="text-2xl font-semibold mb-4">
      {% if insp %}
        編輯檢驗紀錄
      {% else %}
        新增檢驗紀錄
      {% endif %}
    </h2>

    <form 
      {% if insp %}
        hx-post="/inspection/{{ insp.id }}/edit"
      {% else %}
        hx-post="/inspection/new"
      {% endif %}

      hx-on="htmx:afterOnLoad: this.closest('.fixed').remove()"
    >
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        {% if not insp %}
        <div class="col-span-1 md:col-span-2">
            <label for="vehicle_id" class="block text-sm font-medium text-gray-700">車輛</label>
            <select name="vehicle_id" id="vehicle_id" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option value="">-- 請選擇車輛 --</option>
              {% for v in all_vehicles %}
                <option value="{{ v.id }}" {% if selected_vehicle_id and selected_vehicle_id == v.id %}selected{% endif %}>
                  {{ v.plate_no }} ({{ v.model or '' }})
                </option>
              {% endfor %}
            </select>
        </div>
        {% endif %}

        <div>
          <label for="kind" class="block text-sm font-medium text-gray-700">檢驗類型</label>
          <select name="kind" id="kind" required
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            {% for k in inspection_kinds %}
              <option value="{{ k.value }}" {% if insp and insp.kind == k %}selected{% endif %}>
                {{ inspection_kind_map.get(k.value, k.value) }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="result" class="block text-sm font-medium text-gray-700">結果</label>
          <input type="text" name="result" id="result" value="{{ insp.result if insp else '' }}"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <hr class="col-span-1 md:col-span-2 my-2">

        <div>
          <label for="notification_date" class="block text-sm font-medium text-gray-700">接收通知日期</label>
          <input type="date" name="notification_date" id="notification_date" 
                 value="{{ insp.notification_date.strftime('%Y-%m-%d') if insp and insp.notification_date else '' }}" 
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="deadline_date" class="block text-sm font-medium text-gray-700">最晚日期(期限)</label>
          <input type="date" name="deadline_date" id="deadline_date" 
                 value="{{ insp.deadline_date.strftime('%Y-%m-%d') if insp and insp.deadline_date else '' }}" 
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="col-span-1 md:col-span-2">
          <label for="notification_source" class="block text-sm font-medium text-gray-700">通知方式(告知者)</label>
          <input type="text" name="notification_source" id="notification_source" value="{{ insp.notification_source if insp else '' }}"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <hr class="col-span-1 md:col-span-2 my-2">

        <div>
          <label for="inspected_on" class="block text-sm font-medium text-gray-700">實際驗車日期</label>
          <input type="date" name="inspected_on" id="inspected_on" 
                 value="{{ insp.inspected_on.strftime('%Y-%m-%d') if insp and insp.inspected_on else '' }}" 
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="return_date" class="block text-sm font-medium text-gray-700">牽車(回)日期</label>
          <input type="date" name="return_date" id="return_date" 
                 value="{{ insp.return_date.strftime('%Y-%m-%d') if insp and insp.return_date else '' }}" 
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="next_due_on" class="block text-sm font-medium text-gray-700">下次應驗日期</label>
          <input type="date" name="next_due_on" id="next_due_on" 
                 value="{{ insp.next_due_on.strftime('%Y-%m-%d') if insp and insp.next_due_on else '' }}" 
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <hr class="col-span-1 md:col-span-2 my-2">

        <div>
          <label for="user_id" class="block text-sm font-medium text-gray-700">當時使用人</label>
          <select name="user_id" id="user_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="">-- 無 --</option>
            {% for emp in all_employees %}
              <option value="{{ emp.id }}" {% if insp and insp.user_id == emp.id %}selected{% endif %}>
                {{ emp.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="handler_id" class="block text-sm font-medium text-gray-700">經手人</label>
          <select name="handler_id" id="handler_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="">-- 無 --</option>
            {% for emp in all_handlers %}
              <option value="{{ emp.id }}" {% if insp and insp.handler_id == emp.id %}selected{% endif %}>
                {{ emp.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="amount" class="block text-sm font-medium text-gray-700">金額 (填入會自動產生費用單)</label>
          <input type="number" step="0.01" name="amount" id="amount" value="{{ insp.amount if insp else '' }}"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="flex items-center pt-6">
            <input id="is_reconciled" name="is_reconciled" type="checkbox" value="True" 
                   {% if insp and insp.is_reconciled %}checked{% endif %}
                   class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="is_reconciled" class="ml-2 block text-sm text-gray-900">已對帳 (勾選會自動標記費用單)</label>
        </div>

        <div class="col-span-1 md:col-span-2">
            <label for="notes" class="block text-sm font-medium text-gray-700">檢驗細節(附註)</label>
            <textarea name="notes" id="notes" rows="2"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >{{ insp.notes if insp else '' }}</textarea>
        </div>

        <div class="col-span-1 md:col-span-2">
            <label for="handler_notes" class="block text-sm font-medium text-gray-700">聯絡事宜(備註)</label>
            <textarea name="handler_notes" id="handler_notes" rows="2"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >{{ insp.handler_notes if insp else '' }}</textarea>
        </div>

      </div>

      <div class="mt-6 flex justify-end space-x-3">
        <button type="button" 
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
                hx-on:click="this.closest('.fixed').remove()"
        >
          取消
        </button>
        <button type="submit"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700"
        >
          儲存
        </button>
      </div>
    </form>

  </div>
</div>